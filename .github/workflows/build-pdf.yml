name: Build PDF & Deploy

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install reportlab>=4.0.0

      - name: Try pandoc first
        id: pandoc
        continue-on-error: true
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc texlive-xetex
          pandoc spec/OERC-S_v0.1.md -o spec/OERC-S_v0.1.pdf --pdf-engine=xelatex -V geometry:margin=1in

      - name: Fallback to Python
        if: steps.pandoc.outcome == 'failure'
        run: |
          python scripts/build_pdf.py spec/OERC-S_v0.1.md spec/OERC-S_v0.1.pdf

      - name: Prepare Pages
        run: |
          mkdir -p _site
          cp -r schemas _site/
          cp -r spec _site/
          cp -r conformance _site/
          cp README.md _site/
          cp LICENSE _site/
          echo '<!DOCTYPE html><html><head><meta charset="utf-8"><title>OERC-S</title></head><body><h1>OERC-S v0.1</h1><p>Collapse is payable. Everything else is not.</p><ul><li><a href="spec/OERC-S_v0.1.pdf">Specification PDF</a></li><li><a href="spec/OERC-S_v0.1.md">Specification Markdown</a></li><li><a href="schemas/">JSON Schemas</a></li><li><a href="conformance/vectors/">Conformance Vectors</a></li></ul></body></html>' > _site/index.html

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

  deploy:
    if: github.ref == 'refs/heads/main'
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
